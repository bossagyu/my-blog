<!doctype html><html lang=en-US dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Building a FastAPI backend that automatically syncs Google Cloud Storage files with Gemini File Search API via Eventarc. Covers event-driven architecture design and implementation patterns for extensibility."><title>Designing an Event-Driven Backend to Sync GCS with Gemini File Search API</title><link rel=canonical href=https://bossagyu.com/en/blog/048-lawve-backend/><link rel=stylesheet href=/scss/style.min.88a5c216a49d6b6c7d5518453faea9f70881482cfb770cb8b16ba1cbb7dad83f.css><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5880954007617915" crossorigin=anonymous></script><meta property="og:title" content="Designing an Event-Driven Backend to Sync GCS with Gemini File Search API"><meta property="og:description" content="Building a FastAPI backend that automatically syncs Google Cloud Storage files with Gemini File Search API via Eventarc. Covers event-driven architecture design and implementation patterns for extensibility."><meta property="og:url" content="https://bossagyu.com/en/blog/048-lawve-backend/"><meta property="og:site_name" content="Bossagyu Blog"><meta property="og:type" content="article"><meta property="article:section" content="Blog"><meta property="article:tag" content="Python"><meta property="article:tag" content="GCP"><meta property="article:tag" content="Gemini"><meta property="article:tag" content="FastAPI"><meta property="article:published_time" content="2026-02-15T00:00:00+09:00"><meta property="article:modified_time" content="2026-02-15T00:00:00+09:00"><meta property="og:image" content="https://bossagyu.com/images/share.webp"><meta name=twitter:title content="Designing an Event-Driven Backend to Sync GCS with Gemini File Search API"><meta name=twitter:description content="Building a FastAPI backend that automatically syncs Google Cloud Storage files with Gemini File Search API via Eventarc. Covers event-driven architecture design and implementation patterns for extensibility."><meta name=twitter:card content="summary"><meta name=twitter:image content="https://bossagyu.com/images/share.webp"><link rel="shortcut icon" href=/images/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-5JL2R6XT6H"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5JL2R6XT6H",{anonymize_ip:!1})}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Designing an Event-Driven Backend to Sync GCS with Gemini File Search API","description":"Building a FastAPI backend that automatically syncs Google Cloud Storage files with Gemini File Search API via Eventarc. Covers event-driven architecture design and implementation patterns for extensibility.","image":"https:\/\/bossagyu.com\/images\/share.webp","author":{"@type":"Person","name":"bossagyu","url":"https:\/\/bossagyu.com"},"publisher":{"@type":"Organization","name":"Bossagyu Blog","url":"https:\/\/bossagyu.com","logo":{"@type":"ImageObject","url":"https:\/\/bossagyu.com\/images\/share.webp"}},"datePublished":"2026-02-15T00:00:00\u002b09:00","dateModified":"2026-02-15T00:00:00\u002b09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/bossagyu.com\/en\/blog\/048-lawve-backend\/"},"articleSection":"Engineering","keywords":"Python, GCP, Gemini, FastAPI"}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/en><img src=/images/share.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/en>Bossagyu Blog</a></h1><h2 class=site-description>A blog about engineering and management by an engineering manager</h2></div></header><ol class=social-menu><li><a href=https://github.com/bossagyu target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:Bossagyu@yahoo.co.jp target=_blank title=Mail rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg></a></li><li><a href=https://twitter.com/bossagyu target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/en/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/en/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/en/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/en/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://bossagyu.com/en/ selected>en-US üá∫üá∏</option><option value=https://bossagyu.com/>ja-jp üáØüáµ</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#overview>Overview</a></li><li><a href=#system-architecture>System Architecture</a><ol><li><a href=#component-roles>Component Roles</a></li></ol></li><li><a href=#event-driven-architecture-design>Event-Driven Architecture Design</a><ol><li><a href=#why-event-driven>Why Event-Driven?</a></li><li><a href=#event-routing-with-eventarc>Event Routing with Eventarc</a></li><li><a href=#file-upload-processing-flow>File Upload Processing Flow</a></li><li><a href=#file-deletion-processing-flow>File Deletion Processing Flow</a></li></ol></li><li><a href=#integration-with-gemini-file-search-api>Integration with Gemini File Search API</a><ol><li><a href=#unified-gcp-ecosystem>Unified GCP Ecosystem</a></li><li><a href=#file-search-store-overview>File Search Store Overview</a></li><li><a href=#metadata-based-management>Metadata-Based Management</a></li></ol></li><li><a href=#design-patterns-for-extensibility>Design Patterns for Extensibility</a><ol><li><a href=#path-based-metadata-extraction>Path-Based Metadata Extraction</a></li><li><a href=#guaranteeing-state-synchronization-between-gcs-and-gemini-file-search-api>Guaranteeing State Synchronization Between GCS and Gemini File Search API</a></li><li><a href=#local-download-design>Local Download Design</a></li></ol></li><li><a href=#error-handling-and-operational-design>Error Handling and Operational Design</a><ol><li><a href=#always-return-200-ok>Always Return 200 OK</a></li><li><a href=#error-monitoring-via-slack-notifications>Error Monitoring via Slack Notifications</a></li><li><a href=#lazy-initialization-for-client-management>Lazy Initialization for Client Management</a></li></ol></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/en/categories/engineering/>Engineering</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/en/blog/048-lawve-backend/>Designing an Event-Driven Backend to Sync GCS with Gemini File Search API</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 15, 2026</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer><footer class=article-translations><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://bossagyu.com/blog/048-lawve-backend/ class=link>ja-jp üáØüáµ</a></div></footer></div></header><section class=article-content><h2 id=overview>Overview</h2><p>I participated in the &ldquo;Law x Digital&rdquo; Hackathon (3rd edition) hosted by Japan&rsquo;s Digital Agency and developed a cross-source legal document search product called &ldquo;Lawve.&rdquo; Lawve enables natural language search across e-Gov legal data and user-uploaded documents.</p><p>This article focuses on the backend architecture design that I was responsible for. The backend&rsquo;s primary responsibility is to &ldquo;automatically sync the state of Gemini File Search API whenever files are added to or removed from Google Cloud Storage (GCS).&rdquo;</p><h2 id=system-architecture>System Architecture</h2><p>Here is the overall system architecture of Lawve.</p><div class=mermaid-wrapper onclick=openMermaidModal(this)><pre class=mermaid>flowchart TB
    subgraph User
        U[Browser]
    end

    subgraph GCP
        subgraph Frontend
            FE[Cloud Run<br>Next.js]
        end

        subgraph Backend
            CR[Cloud Run<br>FastAPI]
        end

        subgraph Storage & Data
            GCS[(Cloud Storage)]
            FS[(Firestore)]
        end

        subgraph Event Infrastructure
            EA[Eventarc]
        end

        subgraph AI
            GEMINI[Gemini File<br>Search API]
        end
    end

    subgraph External API
        EGOV[e-Gov<br>Law API]
    end

    U --> FE
    FE --> GEMINI
    FE --> FS
    FE --> EGOV
    FE -->|File Upload| GCS

    GCS -->|Event Notification| EA
    EA -->|CloudEvents| CR
    CR -->|Register/Delete| GEMINI
    CR -->|Download| GCS
  </pre><span class=mermaid-hint>„ÇØ„É™„ÉÉ„ÇØ„ÅßÊã°Â§ß</span></div><h3 id=component-roles>Component Roles</h3><div class=table-wrapper><table><thead><tr><th>Component</th><th>Role</th></tr></thead><tbody><tr><td>Cloud Run (Next.js)</td><td>Frontend: search UI, file upload, search result display</td></tr><tr><td>Cloud Run (FastAPI)</td><td>Backend: syncs Gemini File Search API in response to GCS events</td></tr><tr><td>Cloud Storage</td><td>Document storage, serves as the Single Source of Truth</td></tr><tr><td>Eventarc</td><td>Routes GCS file change events to Cloud Run</td></tr><tr><td>Gemini File Search API</td><td>Provides full-text and semantic search for documents</td></tr><tr><td>Firestore</td><td>Manages document metadata and comments</td></tr><tr><td>e-Gov Law API</td><td>Retrieves legal data</td></tr></tbody></table></div><p>This article focuses on the backend Cloud Run (FastAPI) design.</p><h2 id=event-driven-architecture-design>Event-Driven Architecture Design</h2><h3 id=why-event-driven>Why Event-Driven?</h3><p>In a legal document search product, documents need to be automatically registered with Gemini File Search API when placed in GCS. While a synchronous API approach from the frontend was an option, I chose an event-driven architecture for the following reasons:</p><ul><li><strong>Loose coupling</strong>: The frontend only needs to place files in GCS without knowing about the backend</li><li><strong>Reliability</strong>: Eventarc reliably detects GCS events and delivers them to Cloud Run</li><li><strong>Tool compatibility</strong>: Files placed via CLI or scripts are synced in the same way</li></ul><h3 id=event-routing-with-eventarc>Event Routing with Eventarc</h3><p>Eventarc monitors two types of GCS events and routes them to the Cloud Run endpoint.</p><div class=table-wrapper><table><thead><tr><th>Event</th><th>Trigger Condition</th></tr></thead><tbody><tr><td><code>google.cloud.storage.object.v1.finalized</code></td><td>When a file is uploaded to GCS</td></tr><tr><td><code>google.cloud.storage.object.v1.deleted</code></td><td>When a file is deleted from GCS</td></tr></tbody></table></div><p>The Cloud Run endpoint receives events in CloudEvents format.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_storage_event</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=k>await</span> <span class=n>request</span><span class=o>.</span><span class=n>body</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>event</span> <span class=o>=</span> <span class=n>from_http</span><span class=p>(</span><span class=n>headers</span><span class=p>,</span> <span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>event_handler</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=file-upload-processing-flow>File Upload Processing Flow</h3><p>When a file is placed in GCS, it is processed through the following flow:</p><ol><li><strong>Event reception and path filtering</strong>: Only files with the <code>file-search/archive/</code> prefix are processed</li><li><strong>Metadata extraction</strong>: Automatically extract <code>law_id</code> and <code>source_type</code> from the GCS path</li><li><strong>Delete existing documents</strong>: Remove documents with the same <code>source_path</code> to prevent duplicates</li><li><strong>File download</strong>: Download from GCS to a local temporary file</li><li><strong>Register with File Search Store</strong>: Upload to Gemini File Search API with metadata</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventHandler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_handle_event_by_type</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;google.cloud.storage.object.v1.finalized&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_handle_file_upload</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>event_type</span> <span class=o>==</span> <span class=s2>&#34;google.cloud.storage.object.v1.deleted&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_handle_file_delete</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_name</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=file-deletion-processing-flow>File Deletion Processing Flow</h3><p>When a file is deleted from GCS, the corresponding document is also deleted from Gemini File Search API.</p><ol><li><strong>Event reception and path filtering</strong></li><li><strong>Search File Search Store by metadata</strong>: Identify the matching document using the <code>source_path</code> metadata</li><li><strong>Delete document</strong>: Remove the document from File Search Store</li></ol><h2 id=integration-with-gemini-file-search-api>Integration with Gemini File Search API</h2><h3 id=unified-gcp-ecosystem>Unified GCP Ecosystem</h3><p>Lawve adopts a policy of unifying the entire infrastructure on GCP. While other RAG services such as OpenAI and Pinecone were options, I chose Gemini File Search API for its seamless integration with Cloud Run, GCS, and Eventarc.</p><h3 id=file-search-store-overview>File Search Store Overview</h3><p>Gemini File Search Store is a managed service that vectorizes and indexes registered documents to provide semantic search. The backend performs the following operations:</p><ul><li><strong>Document registration</strong>: Upload files with metadata</li><li><strong>Document search</strong>: Search existing documents by metadata</li><li><strong>Document deletion</strong>: Remove documents that are no longer needed</li></ul><h3 id=metadata-based-management>Metadata-Based Management</h3><p>Each document is tagged with three metadata fields for management purposes.</p><div class=table-wrapper><table><thead><tr><th>Metadata</th><th>Purpose</th><th>Example</th></tr></thead><tbody><tr><td><code>law_id</code></td><td>Legal document ID for unique identification</td><td><code>323AC0000000205</code></td></tr><tr><td><code>source_type</code></td><td>Document classification</td><td><code>user</code>, <code>doc</code>, <code>admin</code></td></tr><tr><td><code>source_path</code></td><td>Full GCS path for unique document identification</td><td><code>gs://bucket/file-search/archive/user/323AC0000000205/medical-law.txt</code></td></tr></tbody></table></div><p>Since <code>source_path</code> is the GCS path itself, it uniquely maps GCS files to File Search Store documents.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>metadata</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;law_id&#34;</span><span class=p>:</span> <span class=n>law_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;source_path&#34;</span><span class=p>:</span> <span class=n>source_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;source_type&#34;</span><span class=p>:</span> <span class=n>source_type</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>custom_metadata</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=n>key</span><span class=p>,</span> <span class=s2>&#34;string_value&#34;</span><span class=p>:</span> <span class=n>value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>metadata</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=design-patterns-for-extensibility>Design Patterns for Extensibility</h2><h3 id=path-based-metadata-extraction>Path-Based Metadata Extraction</h3><p>The backend is designed to process any file placed in a specific GCS path, not limited to legal documents. The path convention is as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>gs://&lt;bucket&gt;/file-search/archive/&lt;source_type&gt;/&lt;law_id&gt;/&lt;file_name&gt;
</span></span></code></pre></td></tr></table></div></div><p>The <code>source_type</code> and <code>law_id</code> are automatically extracted from the path using a regular expression.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Path pattern</span>
</span></span><span class=line><span class=cl><span class=n>GCS_PATH_PATTERN</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;file-search/archive/([^/]+)/([^/]+)/.+&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_gcs_path</span><span class=p>(</span><span class=n>gcs_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>GCS_PATH_PATTERN</span><span class=p>,</span> <span class=n>gcs_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><p>This design allows any type of document, such as internal documents or technical documentation, to be managed through the same mechanism. You can add new classifications simply by changing the <code>source_type</code>, and no backend code changes are required as long as the path convention is followed.</p><h3 id=guaranteeing-state-synchronization-between-gcs-and-gemini-file-search-api>Guaranteeing State Synchronization Between GCS and Gemini File Search API</h3><p>GCS serves as the Single Source of Truth, and the design principle is to always keep the File Search Store state in sync with GCS.</p><p><strong>Idempotent uploads</strong>: When the same file is re-uploaded, existing documents are deleted before re-registration. This prevents duplicates while supporting content updates.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_file_upload</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>source_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;gs://</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Check and delete existing documents</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_delete_existing_documents</span><span class=p>(</span><span class=n>source_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># New upload</span>
</span></span><span class=line><span class=cl>    <span class=n>law_id</span> <span class=o>=</span> <span class=n>extract_law_id</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>local_file_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>gcs_client</span><span class=o>.</span><span class=n>download_to_temp_file</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># ...</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>store_client</span><span class=o>.</span><span class=n>upload_file</span><span class=p>(</span><span class=n>local_file_path</span><span class=p>,</span> <span class=n>file_path</span><span class=p>,</span> <span class=n>metadata</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>success</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Cascading deletes</strong>: When a file is deleted from GCS, the corresponding document is automatically removed from the File Search Store. The system searches by <code>source_path</code> metadata and deletes the matching document.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_file_delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>source_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;gs://</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>documents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>store_client</span><span class=o>.</span><span class=n>find_documents_by_source_path</span><span class=p>(</span><span class=n>source_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>documents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>store_client</span><span class=o>.</span><span class=n>delete_document</span><span class=p>(</span><span class=n>documents</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=local-download-design>Local Download Design</h3><p>Registration from GCS to Gemini File Search API is done by first downloading to a local temporary file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>download_to_temp_file</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>,</span> <span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>ext</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>ext</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ext</span> <span class=o>=</span> <span class=s2>&#34;.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>temp_fd</span><span class=p>,</span> <span class=n>temp_path</span> <span class=o>=</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>mkstemp</span><span class=p>(</span><span class=n>suffix</span><span class=o>=</span><span class=n>ext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>temp_fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>blob</span><span class=o>.</span><span class=n>download_to_filename</span><span class=p>(</span><span class=n>temp_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>temp_path</span>
</span></span></code></pre></td></tr></table></div></div><p>While direct upload would be simpler, downloading locally first provides the following benefits:</p><ul><li><strong>Extensibility</strong>: Enables future file transformation steps such as converting Excel to CSV before upload</li><li><strong>MIME detection</strong>: Preserving the file extension enables accurate MIME type detection</li><li><strong>Debugging</strong>: Allows inspection of local file contents when issues occur</li></ul><h2 id=error-handling-and-operational-design>Error Handling and Operational Design</h2><h3 id=always-return-200-ok>Always Return 200 OK</h3><p>The Cloud Run endpoint always returns 200 OK to Eventarc requests, even when errors occur.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_storage_event</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>body</span> <span class=o>=</span> <span class=k>await</span> <span class=n>request</span><span class=o>.</span><span class=n>body</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=n>from_http</span><span class=p>(</span><span class=n>headers</span><span class=p>,</span> <span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>event_handler</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Event processing failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;note&#34;</span><span class=p>:</span> <span class=s2>&#34;Error logged and notified via Slack&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This design prevents Eventarc retries. If the endpoint returns 4xx/5xx, Eventarc resends the event, causing the same error to repeat. This results in duplicate Slack notifications and polluted logs. By returning 200 OK and handling errors through Slack notifications and logging, operational issues are avoided.</p><h3 id=error-monitoring-via-slack-notifications>Error Monitoring via Slack Notifications</h3><p>When a File Search Store upload fails, an error notification is sent via Slack Webhook. The notification includes the GCS path and error details, enabling operators to quickly identify the problem.</p><p>While this Slack-based monitoring is sufficient for hackathon-scale development, a production environment would require more robust monitoring and recovery mechanisms, such as Cloud Monitoring alerts, Cloud Logging integration, and Dead Letter Queues for reprocessing failed events.</p><h3 id=lazy-initialization-for-client-management>Lazy Initialization for Client Management</h3><p>Gemini API clients and GCS clients use lazy initialization.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@property</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>client</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>genai</span><span class=o>.</span><span class=n>Client</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_client</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_client</span> <span class=o>=</span> <span class=n>genai</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_client</span>
</span></span></code></pre></td></tr></table></div></div><p>This allows the application to start even without API keys configured, making it easier to work in test environments or local development without providing all environment variables.</p><h2 id=summary>Summary</h2><p>The Lawve backend was built on the following design principles:</p><ul><li><strong>Loosely coupled automatic sync via event-driven architecture</strong>: Using Eventarc to keep the frontend and backend decoupled while automatically reflecting GCS changes in Gemini File Search API</li><li><strong>Metadata-driven extensible design</strong>: Automatically extracting metadata from path conventions to support documents beyond legal data</li><li><strong>GCS as Single Source of Truth</strong>: Idempotent uploads and cascading deletes ensure the GCS and File Search Store states always match</li></ul><p>By combining an event-driven architecture with GCP managed services, I was able to build a reliable document synchronization platform with minimal code. The simplicity of making documents searchable just by placing files in GCS was a significant advantage during the time-limited hackathon development.</p><p>The source code is available on <a class=link href=https://github.com/23-u-don/lawve-backend target=_blank rel=noopener>GitHub</a>.</p></section><footer class=article-footer><section class=article-tags><a href=/en/tags/python/>Python</a>
<a href=/en/tags/gcp/>GCP</a>
<a href=/en/tags/gemini/>Gemini</a>
<a href=/en/tags/fastapi/>FastAPI</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/en/blog/046-clean-bot-technical/><div class=article-details><h2 class=article-title>Building a Cleaning Reminder Bot with AWS Lambda + LINE</h2></div></a></article><article><a href=/en/blog/044-openai-response-api/><div class=article-details><h2 class=article-title>How to Use the OpenAI Response API</h2></div></a></article><article><a href=/en/blog/033-feast-tutorial/><div class=article-details><h2 class=article-title>Running the Feast Tutorial on macOS</h2></div></a></article><article><a href=/en/blog/032-python-uv/><div class=article-details><h2 class=article-title>Setting Up a Python Development Environment on Mac with UV</h2></div></a></article><article><a href=/en/blog/024-bluesky-api/><div class=article-details><h2 class=article-title>Using Bluesky API for Automated Posting with Python</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 -
2026 Bossagyu Blog</section><section class=powerby><a href=/en/others/contact/>Contact</br></a><a href=/en/others/privacy-policy/>Privacy Policy</br></a></br></section><section class=powerby>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><style>.mermaid-wrapper{position:relative;cursor:pointer}.mermaid-hint{position:absolute;bottom:8px;right:8px;font-size:12px;padding:4px 8px;background:var(--card-background,rgba(0,0,0,.7));border-radius:4px;color:var(--card-text-color-secondary,#888);opacity:0;transition:opacity .2s}.mermaid-wrapper:hover .mermaid-hint{opacity:1}.mermaid-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:9999;cursor:pointer;align-items:center;justify-content:center}.mermaid-modal.active{display:flex}.mermaid-modal-content{width:90vw;max-height:90vh;overflow:auto;background:var(--card-background,#fff);padding:20px;border-radius:8px}.mermaid-modal-content svg{width:100%!important;height:auto!important;min-height:50vh}.mermaid-modal-close{position:absolute;top:20px;right:30px;font-size:32px;color:#fff;cursor:pointer}</style><div class=mermaid-modal id=mermaidModal onclick=closeMermaidModal(event)><span class=mermaid-modal-close>&#215;</span><div class=mermaid-modal-content id=mermaidModalContent></div></div><script>function openMermaidModal(e){const t=e.querySelector("svg");if(t){const e=t.cloneNode(!0);e.removeAttribute("width"),e.removeAttribute("height"),e.style.width="100%",e.style.height="auto";const n=document.getElementById("mermaidModalContent");n.innerHTML="",n.appendChild(e),document.getElementById("mermaidModal").classList.add("active"),document.body.style.overflow="hidden"}}function closeMermaidModal(e){(e.target.id==="mermaidModal"||e.target.classList.contains("mermaid-modal-close"))&&(document.getElementById("mermaidModal").classList.remove("active"),document.body.style.overflow="")}document.addEventListener("keydown",function(e){e.key==="Escape"&&(document.getElementById("mermaidModal").classList.remove("active"),document.body.style.overflow="")})</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  const isDark = document.documentElement.dataset.scheme === 'dark' ||
    (document.documentElement.dataset.scheme === 'auto' &&
     window.matchMedia('(prefers-color-scheme: dark)').matches);

  mermaid.initialize({
    startOnLoad: false,
    theme: isDark ? 'dark' : 'default',
    securityLevel: 'loose'
  });

  await mermaid.run({
    querySelector: '.mermaid'
  });
</script></body></html>